---
title: Lab6 - PID Orientation Control
date: 2024-03-19 22:00:00 +/-0000
categories: [Lab Reports, Lab6]
tags: [Lab6]     # TAG names should always be lowercase
math: true
author: 1
mermaid: true
pin: true
---

## Objective

The purpose of this lab is to realise orientation PID using the IMU. In Lab 5, PID control was done on wall distance using the ToF sensors, this lab will involve controlling the yaw of the robot using the IMU.

## Keywords

BLE, PID Control

## Prelab - Optimization of BLE Data Transfer Module

As for this lab, the BLE module is quite similar to that of Lab5 - Linear PID Distance Control. I recorded the important debug readings inside the PID control loop. Then, I used another case ***SEND_PID_ORIENT_DEBUG_READINGS*** to continuously send the data back to the PC after the robot car finished the PID control mission.

![pid_orient_debug_readings_code](/assets/images/lab6/pid_orient_debug_readings_code.png "pid_orient_debug_readings_code")

On the PC, I used another notification handler function to receive, parse and store the data.

![notification_handler_code](/assets/images/lab6/notification_handler_code.png "notification_handler_code")

## Lab Tasks

### Task 1 - Range/Samping Discussion

Basically, what we get from the IMU is the angular velocity. So, in order to get the orientation angle in degrees, we need to "integrate" the velocity during ***dt*** to estimate the angle:

![yaw_integration](/assets/images/lab6/yaw_integration.png "yaw_integration")

From the official document of the IMU, there is the angular rate's modes:

![imu_property](/assets/images/lab6/imu_property.png "imu_property")

This is very critical because when the robot car's orientation angle suddenly changes, the angular velocity from the sudden change can be huge, which the IMU cannot accurately measure. During the physical experiments in the lab, I discovered that when I kicked the robot car to change its orientation hugely, because of the "low" sampling rate of the angular velocities, the IMU will tend to return a orientation angle which is rather lower than the actual angle. (**Note** This has been tested even when the rate was changed to the maximum 2000dps)

So, to reduce the error, I directly changed the angular rate from the default 250dps to the maximum 2000dps.

### Task 2 - Range of P-Controller Gain

In this task, the error is from the orientation angle. The value of the angle in degrees from IMU can be some hundred even over Â±360 degrees. But the IMU will tend to firstly get the initial orientation angle within [-360, 360] degrees. So, the error is about some hundred. In this case, the order of magnitude of the p-controller's gain $K_p$ will be approximately between $10^{-1}$ to $10^0$.

### Task 3 - P/I/D Controller Implementation

Similar to Lab5, I used the heuristic procedure (#1) to find the value of P/I/D:

![heuristic_procedure](/assets/images/lab5/heuristic_procedure.png "heuristic_procedure")

Also, before I implemented the PID, I used the case ***PID_STATUS_INI*** to initialize all the PID-related parameters:

![pid_status_ini](/assets/images/lab6/pid_status_ini.png "pid_status_ini")

As for the limit of the PWM duty cycle value, I set the deadband to 180 for car's rotatation and set the 255 as the maximum value.

#### P-Controller

